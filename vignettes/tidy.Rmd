---
title: "Getting Started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The tidy.helpers package offers a suite of functions that make easy to interact, add information, and manipulate tibbles created with `broom::tidy()` (and friends).

As a motivating example, let's summarize a logistic regression model with a forest plot and in a table.

To begin, let's load our packages.

```{r setup, warning=FALSE, message=FALSE}
library(broom.helpers); library(gtsummary)
library(ggplot2); library(dplyr)
```

Our model predicts tumor response using chemotherapy treatment and tumor grade.
The data set we're utilizing has already labelled the columns using the [labelled package](http://larmarange.github.io/labelled/).
The column labels will be carried through to our figure and table.

```{r}
model_logit <- glm(response ~ trt + grade, trial, family = binomial)
broom::tidy(model_logit)
```

## Forest Plot

To create the figure, we'll need to add some information to the tidy tibble, e.g. we'll need to group the terms that belong to the same variable, add the reference row, etc.
Parsing this information can be difficult, but the broom.helper package has made it simple.

```{r}
tidy_forest <-
  model_logit %>%
  # perform initial tidying of the model
  tidy_and_attach(exponentiate = TRUE, conf.int = TRUE) %>%
  # adding in the reference row for categorical variables
  tidy_add_reference_rows() %>%
  # adding a reference value to appear in plot
  tidy_add_estimate_to_reference_rows(exponentiate = TRUE) %>%
  # adding the variable labels
  tidy_add_term_labels() %>%
  # removing intercept estimate from model
  tidy_remove_intercept()
tidy_forest
```

We now have a tibble with every piece of information we need to create our forest plot.

```{r, warning=FALSE}
tidy_forest %>%
  mutate(
    plot_label = paste(var_label, label, sep = ":") %>% 
      forcats::fct_inorder() %>%
      forcats::fct_rev()
  ) %>%
  ggplot(aes(x = plot_label, y = estimate, ymin = conf.low, ymax = conf.high)) +
  geom_pointrange(aes(col = plot_label)) +
  geom_hline(yintercept = 1, linetype = 2) +
  coord_flip() +
  theme(legend.position = "none") +
  labs(
    y = "Odds Ratio",
    x = " ",
    title = "Forest Plot using broom.helpers"
  )
```

## Table Summary

In addition to aiding in figure creation, the broom.helpers package can help summarize a model in a table.
In the example below, we add header and reference rows, and utilize existing variable labels.
Let's change the labels shown in our summary table as well.

```{r}
tidy_table <-
  model_logit %>%
  # perform initial tidying of the model
  tidy_and_attach(exponentiate = TRUE, conf.int = TRUE) %>%
  # adding in the reference row for categorical variables
  tidy_add_reference_rows() %>%
  # adding the variable labels
  tidy_add_term_labels() %>%
  # add header row
  tidy_add_header_rows() %>%
  # removing intercept estimate from model
  tidy_remove_intercept() 

# print summary table
options(knitr.kable.NA = '')
tidy_table %>%
  # format model estimates
  select(label, estimate, conf.low, conf.high, p.value) %>%
  mutate_at(vars(estimate, conf.low, conf.high), style_ratio) %>%
  mutate_at(vars(p.value), style_pvalue) %>%
  knitr::kable()
```

There is also a handy wrapper for the most commonly used `tidy_*()` functions, and they can be executed with a single line of code:

```{r}
model_logit %>%
  tidy_plus_plus(exponentiate = TRUE, conf.int = TRUE)
```
